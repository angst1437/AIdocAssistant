<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DocAssistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@latest/dist/docx-preview.js"></script>
</head>
<body>
    <div class="container-fluid vh-100 d-flex p-0">
        <div id="inputs" class="col-4 h-100 border-end d-flex flex-column">
            <form id="title-form" class="needs-validation overflow-auto p-3" needs-validation>
                <h2 class="mb-4 text-primary">Оформление титульного листа</h2>
                
                <!-- Университет -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        Учебное заведение и подразделения
                        <span class="text-muted d-block small">(каждый элемент с новой строки)</span>
                    </label>
                    <textarea name="university-info" 
                            class="form-control" 
                            rows="3"
                            placeholder="Челябинский государственный университет&#10;Институт информационных технологий..."
                            required></textarea>
                </div>
        
                <!-- Основные поля в 2 колонки -->
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <label class="form-label fw-semibold">Тип работы</label>
                        <input name="work-type" 
                            type="text" 
                            class="form-control" 
                            placeholder="Реферат" 
                            required>
                    </div>
                    
                    <div class="col-6">
                        <label class="form-label fw-semibold">Дисциплина</label>
                        <input name="work-subject" 
                            type="text" 
                            class="form-control" 
                            placeholder="Экономическая теория" 
                            required>
                    </div>
                </div>
        
                <!-- Тема -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Тема работы</label>
                    <input name="work-theme" 
                        type="text" 
                        class="form-control" 
                        placeholder="Влияние плановой экономики на экономику СССР" 
                        required>
                </div>
        
                <!-- Личные данные -->
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <label class="form-label fw-semibold">Ваше ФИО</label>
                        <input name="fullname" 
                            type="text" 
                            class="form-control" 
                            placeholder="Иванов А.А." 
                            required>
                    </div>
                    
                    <div class="col-6">
                        <label class="form-label fw-semibold">Группа</label>
                        <input name="group" 
                            type="text" 
                            class="form-control" 
                            placeholder="ПИ-201" 
                            required>
                    </div>
                </div>
        
                <!-- Проверяющий -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Руководитель</label>
                    <input name="educator" 
                        type="text" 
                        class="form-control" 
                        placeholder="Кандидат наук, доцент Петриченко Ю. В." 
                        required>
                </div>
        
                <!-- Город -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Город</label>
                    <input name="city" 
                        type="text" 
                        class="form-control" 
                        placeholder="Челябинск" 
                        required>
                </div>
            </form>
            
            <!-- Контейнер для кнопок -->
            <div class="p-3 pt-3 border-top" style="position: sticky; bottom: 0; background: white; z-index: 1000;">
                <button type="submit" form="title-form" class="btn btn-primary w-100 py-2">
                    <i class="bi bi-file-text me-2"></i>Сформировать
                </button>
                <button id="download-btn" 
                        class="btn btn-secondary w-100 py-2 mt-2" 
                        disabled
                        title="Доступно после генерации документа">
                    <i class="bi bi-download me-2"></i>Скачать
                </button>
            </div>
        </div>
        <div id="preview" class="overflow-auto flex-grow-1 h-100">
            <div id="preview-notice" class="text-muted text-center h-100 d-flex align-items-center justify-content-center">
                Заполните форму слева, чтобы увидеть документ
            </div>
        </div>
    </div>

    <script>
        let currentBlobUrl = null;

        const titleForm = document.getElementById('title-form');
        const preview = document.getElementById('preview');
        const downloadBtn = document.getElementById('download-btn');

        // Обработчик скачивания
        const handleDownload = () => {
            const link = document.createElement('a');
            link.href = currentBlobUrl;
            link.download = downloadBtn.dataset.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        titleForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const formData = new FormData(titleForm);
            const data = Object.fromEntries(formData.entries());
            
            try {
                
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                if (!response.ok) throw new Error('Ошибка генерации документа');
                
                const blob = await response.blob();
                
                // Очистка предыдущего blob
                if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
                
                // Обновляем кнопку
                currentBlobUrl = URL.createObjectURL(blob);
                const fileName = `${data['work-theme'].replace(/[^a-zа-яё\d]/gi, '_')}.docx`;
                downloadBtn.dataset.filename = fileName;
                downloadBtn.onclick = handleDownload;
                downloadBtn.disabled = false;
                downloadBtn.classList.replace('btn-secondary', 'btn-success');

                // Рендер документа
                docx.renderAsync(blob, preview, null, {
                    className: "docx",
                });
            } catch (error) {
                console.error('Ошибка:', error);
                preview.innerHTML = `<p style="color: red">${error.message}</p>`;
                downloadBtn.disabled = true;
                downloadBtn.classList.replace('btn-success', 'btn-secondary');
            }
        };
    </script>
</body>
</html>