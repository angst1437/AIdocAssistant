{% extends "base.html" %}

{% block title %}{{ section.name }} | {{ document.title }} | НИР Ассистент{% endblock %}

{% block styles %}
{# --- Стили оставляем как есть --- #}
<style>
    .section-nav { background-color: #f3f4f6; border-radius: 1rem; padding: 1rem; }
    .section-nav-item { display: flex; align-items: center; justify-content: center; width: 3rem; height: 3rem; border-radius: 50%; background-color: #e5e7eb; color: #4b5563; font-weight: 600; margin: 0.5rem 0; position: relative; }
    .section-nav-item.active { background-color: #4b5563; color: white; }
    .section-nav-item:not(:last-child)::after { content: ''; position: absolute; top: 100%; left: 50%; width: 2px; height: 1rem; background-color: #d1d5db; }
    .section-nav-connector { width: 2px; height: 1rem; background-color: #d1d5db; margin: 0 auto; }
    .toast { position: fixed; bottom: 1rem; right: 1rem; padding: 1rem; background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); z-index: 50; transition: transform 0.3s, opacity 0.3s; transform: translateY(100%); opacity: 0; }
    .toast.show { transform: translateY(0); opacity: 1; }
    /* Стиль для статического текста */
    .static-text-field { padding-top: 0.5rem; /* Примерный отступ сверху, как у input */ }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row h-full">
    <!-- Навигация по секциям -->
    <div class="w-full md:w-1/6 p-4">
        <div class="section-nav">
            {# Используем template_sections, переданный из Flask #}
            {% for nav_section in template_sections %}
            <a href="{{ url_for('documents.edit_section', document_id=document.id, section_slug=nav_section.slug) }}" class="block">
                {# Сравниваем ID текущей секции (section.id) с ID секции в навигации (nav_section.id) #}
                <div class="section-nav-item {% if nav_section.id == section.id %}active{% endif %}" title="{{ nav_section.name }}">
                    {{ nav_section.code }}
                </div>
                {# Используем loop.last для корректного отображения соединителя #}
                {% if not loop.last %}
                <div class="section-nav-connector"></div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Форма -->
    <div class="w-full md:w-5/6 p-4">
        <!-- Шапка секции -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-4">
            <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-900">{{ section.name }}</h1>
                <div class="flex space-x-2">
                    {# --- УНИКАЛЬНЫЙ ID для кнопки в шапке --- #}
                    <button id="save-section-header-{{ section.slug }}" type="button" class="save-button inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Сохранить
                    </button>
                    <a href="{{ url_for('documents.structure', document_id=document.id) }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Вернуться к документу
                    </a>
                </div>
            </div>
        </div>

        <!-- Основной блок формы -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                {# --- УНИКАЛЬНЫЙ ID для формы --- #}
                <form id="section-form-{{ section.slug }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    {# --- Используем переменную form_schema (список словарей), переданную из Flask --- #}
                    {% if form_schema %}
                        {% for field in form_schema %}
                            <div class="mb-4">
                                <label for="section-{{ section.slug }}-{{ field.name }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>

                                {# --- Получаем текущее значение, учитывая значение по умолчанию из схемы --- #}
                                {% set default_value = field.default if field.default is defined else '' %}
                                {% set current_value = section_content.form_data.get(field.name, default_value) %}

                                {# --- Обработка типов полей --- #}
                                {% if field.type == 'text' %}
                                    <input type="text" id="section-{{ section.slug }}-{{ field.name }}" name="{{ field.name }}" value="{{ current_value }}"
                                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                           {% if field.required %}required{% endif %}>

                                {% elif field.type == 'textarea' %}
                                    <textarea id="section-{{ section.slug }}-{{ field.name }}" name="{{ field.name }}" rows="3"
                                              class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                              {% if field.required %}required{% endif %}>{{ current_value }}</textarea>

                                {% elif field.type == 'select' %}
                                    <select id="section-{{ section.slug }}-{{ field.name }}" name="{{ field.name }}"
                                            class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            {% if field.required %}required{% endif %}>
                                        {# Добавляем пустую опцию, если не обязательное и нет значения #}
                                        {% if not field.required and not current_value %}
                                        <option value="" selected>-- Не выбрано --</option>
                                        {% endif %}
                                        {% for option in field.options %}
                                            <option value="{{ option.value }}" {% if current_value|string == option.value|string %}selected{% endif %}>{{ option.label }}</option> {# Сравниваем как строки на всякий случай #}
                                        {% endfor %}
                                    </select>

                                {% elif field.type == 'date' %}
                                    <input type="date" id="section-{{ section.slug }}-{{ field.name }}" name="{{ field.name }}" value="{{ current_value }}"
                                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                           {% if field.required %}required{% endif %}>

                                {% elif field.type == 'checkbox' %}
                                    <div class="mt-1 flex items-center">
                                        {# Значение 1 отправляется, только если чекбокс отмечен #}
                                        <input type="checkbox" id="section-{{ section.slug }}-{{ field.name }}" name="{{ field.name }}" value="1"
                                               class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                                               {% if current_value == '1' or current_value == True %}checked{% endif %}>
                                        <label for="section-{{ section.slug }}-{{ field.name }}" class="ml-2 block text-sm text-gray-900">{{ field.checkbox_label | default(field.label) }}</label>
                                    </div>

                                {# --- ДОБАВЛЕНО: Обработка number --- #}
                                {% elif field.type == 'number' %}
                                    <input type="number" id="section-{{ section.slug }}-{{ field.name }}" name="{{ field.name }}" value="{{ current_value }}"
                                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                           {% if field.min is defined %} min="{{ field.min }}" {% endif %}
                                           {% if field.max is defined %} max="{{ field.max }}" {% endif %}
                                           {% if field.step is defined %} step="{{ field.step }}" {% endif %}
                                           {% if field.required %}required{% endif %}>

                                {# --- ДОБАВЛЕНО: Обработка static-text --- #}
                                {% elif field.type == 'static-text' %}
                                     <p class="mt-1 text-sm text-gray-800 font-medium static-text-field">{{ field.value }}</p>
                                     {# Не создаем input, это просто текст #}

                                {# --- ДОБАВЛЕНО: Обработка array (заглушка) --- #}
                                {% elif field.type == 'array' %}
                                    <div class="mt-1 p-2 border rounded bg-gray-100 text-gray-600">
                                        Поле типа "array" ({{ field.name }}) требует специального интерфейса (пока не реализовано).
                                        <details>
                                            <summary class="text-xs cursor-pointer">Текущие данные (JSON)</summary>
                                            <pre class="text-xs bg-white p-1 mt-1 overflow-auto">{{ section_content.form_data.get(field.name)|tojson(indent=2) }}</pre>
                                        </details>
                                    </div>

                                {% else %}
                                     <p class="mt-1 text-sm text-red-600">Неизвестный тип поля: {{ field.type }}</p>
                                {% endif %}

                                {# --- Отображение help_text --- #}
                                {% if field.help_text %}
                                    <p class="mt-1 text-sm text-gray-500">{{ field.help_text }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        {# Этот блок выводится, если form_schema пустой или не передан #}
                        <p class="text-gray-500">Для этой секции не определена схема формы.</p>
                        {# Можно добавить сюда базовый редактор, если нужно #}
                        {# <textarea name="content" ...>{{ section_content.content }}</textarea> #}
                    {% endif %}

                    <!-- Кнопка сохранения внизу формы -->
                    <div class="flex justify-end pt-4 border-t mt-6">
                        {# --- УНИКАЛЬНЫЙ ID для кнопки в подвале --- #}
                        <button id="save-section-footer-{{ section.slug }}" type="button" class="save-button inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Сохранить изменения
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
{# ... код toast без изменений ... #}
<div id="toast" class="toast">...</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... (showToast, getCsrfToken без изменений) ...
        function showToast(message, type = 'success') { /* ... */ }
        function getCsrfToken() { /* ... */ }

        // --- УЛУЧШЕННАЯ Функция сохранения ---
        function saveSectionForm() {
            {# --- Используем ПРАВИЛЬНЫЙ ID формы --- #}
            const form = document.getElementById('section-form-{{ section.slug }}');
            if (!form) {
                console.error('Form #section-form-{{ section.slug }} not found!');
                showToast('Ошибка: Не удалось найти форму для сохранения.', 'error');
                return;
            }
            const formData = new FormData(form);
            const documentId = {{ document.id }};
            const sectionId = {{ section.id }}; // ID шаблонной секции
            const saveUrl = `/documents/${documentId}/section/${sectionId}/update`;

            // --- Индикация загрузки ---
            // Добавляем общий класс 'save-button', чтобы легче найти обе кнопки
            const saveButtons = document.querySelectorAll('.save-button');
            saveButtons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed'); // Визуальная блокировка
            });
            showToast('Сохранение...', 'info'); // Показываем процесс

            fetch(saveUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                    // 'Accept': 'application/json' // Хорошая практика
                },
                body: formData
            })
            .then(response => {
                // Получаем статус и пытаемся распарсить JSON в любом случае
                const status = response.status;
                return response.json().then(data => ({ ok: response.ok, status, data }) );
            })
            .then(({ ok, status, data }) => {
                if (ok && data.success) {
                    showToast('Секция успешно сохранена');
                } else {
                    // Пытаемся показать сообщение об ошибке от сервера или статус
                    const errorMsg = data?.message || `Ошибка ${status}`;
                    showToast(`Ошибка сохранения: ${errorMsg}`, 'error');
                    console.error('Save error response:', data);
                }
            })
            .catch(error => {
                console.error('Error saving section form:', error);
                showToast(`Сетевая ошибка или ошибка парсинга: ${error.message}`, 'error');
            })
            .finally(() => {
                 // --- Снимаем блокировку кнопок ---
                 saveButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                 });
            });
        }

        // --- Вешаем обработчики на ОБЕ кнопки сохранения по их уникальным ID ---
        const saveBtnFooter = document.getElementById('save-section-footer-{{ section.slug }}');
        if (saveBtnFooter) {
            saveBtnFooter.addEventListener('click', saveSectionForm);
        } else {
            console.warn('Footer save button not found');
        }

        const saveBtnHeader = document.getElementById('save-section-header-{{ section.slug }}');
         if (saveBtnHeader) {
            saveBtnHeader.addEventListener('click', saveSectionForm);
         } else {
             console.warn('Header save button not found');
         }
    });
</script>
{% endblock %}